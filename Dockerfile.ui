# syntax=docker/dockerfile:1

# Builder stage
FROM node:20.10.0-alpine AS builder
WORKDIR /app

RUN npm install -g pnpm@9.0.0

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/maximo-extension-ui/package.json apps/maximo-extension-ui/
RUN pnpm install --filter maximo-extension-ui... --frozen-lockfile
COPY apps/maximo-extension-ui apps/maximo-extension-ui
RUN pnpm -F maximo-extension-ui build

# Final stage
FROM node:20.10.0-alpine
WORKDIR /app

RUN apk add --no-cache curl \
    && npm install -g pnpm@9.0.0

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/maximo-extension-ui/package.json apps/maximo-extension-ui/
RUN pnpm install --filter maximo-extension-ui... --frozen-lockfile --prod
COPY --from=builder /app/apps/maximo-extension-ui/.next apps/maximo-extension-ui/.next
COPY --from=builder /app/apps/maximo-extension-ui/public apps/maximo-extension-ui/public

# Create non-root user
RUN adduser -D appuser && chown -R appuser /app
USER appuser

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 CMD curl -fsS http://localhost:3000/ || exit 1

CMD ["pnpm", "-F", "maximo-extension-ui", "start"]
